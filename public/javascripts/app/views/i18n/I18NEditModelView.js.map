{"version":3,"sources":["app/views/i18n/I18NEditModelView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/i18n/I18NEditModelView.js","sourcesContent":["RootView = require 'views/core/RootView'\nlocale = require 'locale/locale'\nPatch = require 'models/Patch'\nPatches = require 'collections/Patches'\nPatchModal = require 'views/editor/PatchModal'\ntemplate = require 'templates/i18n/i18n-edit-model-view'\ndeltasLib = require 'core/deltas'\nace = require 'ace'\n\n###\n  This view is the superclass for all views which Diplomats use to submit translations\n  for database documents. They all work mostly the same, except they each set their\n  `@modelClass` which is a patchable Backbone model class, and they use `@wrapRow()`\n  to dynamically specify which properties are being translated.\n###\n  \nUNSAVED_CHANGES_MESSAGE = 'You have unsaved changes! Really discard them?'\n\nmodule.exports = class I18NEditModelView extends RootView\n  className: 'editor i18n-edit-model-view'\n  template: template\n\n  events:\n    'input .translation-input': 'onInputChanged'\n    'change #language-select': 'onLanguageSelectChanged'\n    'click #patch-submit': 'onSubmitPatch'\n    'click .open-patch-link': 'onClickOpenPatchLink'\n\n  constructor: (options, @modelHandle) ->\n    super(options)\n\n    @model = new @modelClass(_id: @modelHandle)\n    @supermodel.trackRequest(@model.fetch())\n    @patches = new Patches()\n    @listenTo @patches, 'change', -> @renderSelectors('#patches-col')\n    @patches.comparator = '_id'\n    @supermodel.trackRequest(@patches.fetchMineFor(@model))\n\n    @selectedLanguage = me.get('preferredLanguage', true)\n    @madeChanges = false\n\n  showLoading: ($el) ->\n    $el ?= @$el.find('.outer-content')\n    super($el)\n\n  onLoaded: ->\n    super()\n    @originalModel = @model.clone()\n\n  getRenderData: ->\n    c = super()\n\n    c.model = @model\n    c.selectedLanguage = @selectedLanguage\n\n    @translationList = []\n    if @supermodel.finished() then @buildTranslationList() else []\n    result.index = index for result, index in @translationList\n    c.translationList = @translationList\n\n    c\n\n  afterRender: ->\n    super()\n\n    @ignoreLanguageSelectChanges = true\n    $select = @$el.find('#language-select').empty()\n    @addLanguagesToSelect($select, @selectedLanguage)\n    @$el.find('option[value=\"en-US\"]').remove()\n    @ignoreLanguageSelectChanges = false\n    editors = []\n\n    @$el.find('tr[data-format=\"markdown\"]').each((index, el) =>\n      foundEnEl = enEl=$(el).find('.english-value-row div')[0]\n      if foundEnEl?\n        englishEditor = ace.edit(foundEnEl)\n        englishEditor.el = enEl\n        englishEditor.setReadOnly(true)\n        editors.push englishEditor\n      foundToEl = toEl=$(el).find('.to-value-row div')[0]\n      if foundToEl?\n        toEditor = ace.edit(foundToEl)\n        toEditor.el = toEl\n        toEditor.on 'change', @onEditorChange\n        editors.push toEditor\n    )\n\n    for editor in editors\n      session = editor.getSession()\n      session.setTabSize 2\n      session.setMode 'ace/mode/markdown'\n      session.setNewLineMode = 'unix'\n      session.setUseSoftTabs true\n      editor.setOptions({ maxLines: Infinity })\n\n  onEditorChange: (event, editor) =>\n    return if @destroyed\n    index = $(editor.el).data('index')\n    rowInfo = @translationList[index]\n    value = editor.getValue()\n    @onTranslationChanged(rowInfo, value)\n\n  wrapRow: (title, key, enValue, toValue, path, format) ->\n    @translationList.push {\n      title: title,\n      key: key,\n      enValue: enValue,\n      toValue: toValue or '',\n      path: path\n      format: format\n    }\n\n  buildTranslationList: -> [] # overwrite\n\n  onInputChanged: (e) ->\n    index = $(e.target).data('index')\n    rowInfo = @translationList[index]\n    value = $(e.target).val()\n    @onTranslationChanged(rowInfo, value)\n\n  onTranslationChanged: (rowInfo, value) ->\n    #- Navigate down to where the translation will live\n    base = @model.attributes\n\n    for seg in rowInfo.path\n      base = base[seg]\n\n    base = base.i18n\n\n    base[@selectedLanguage] ?= {}\n    base = base[@selectedLanguage]\n\n    if rowInfo.key.length > 1\n      for seg in rowInfo.key[..-2]\n        base[seg] ?= {}\n        base = base[seg]\n\n    #- Set the data in a non-kosher way\n    base[rowInfo.key[rowInfo.key.length-1]] = value\n    @model.saveBackup()\n\n    #- Enable patch submit button\n    @$el.find('#patch-submit').attr('disabled', null)\n    @madeChanges = true\n\n  onLanguageSelectChanged: (e) ->\n    return if @ignoreLanguageSelectChanges\n    if @madeChanges\n      return unless confirm(UNSAVED_CHANGES_MESSAGE)\n    @selectedLanguage = $(e.target).val()\n    if @selectedLanguage\n      me.set('preferredLanguage', @selectedLanguage)\n      me.patch()\n    @madeChanges = false\n    @model.set(@originalModel.clone().attributes)\n    @render()\n\n  onClickOpenPatchLink: (e) ->\n    patchID = $(e.currentTarget).data('patch-id')\n    patch = @patches.get(patchID)\n    modal = new PatchModal(patch, @model)\n    @openModalView(modal)\n\n  onLeaveMessage: ->\n    if @madeChanges\n      return UNSAVED_CHANGES_MESSAGE\n\n  onSubmitPatch: (e) ->\n    delta = @originalModel.getDeltaWith(@model)\n    flattened = deltasLib.flattenDelta(delta)\n    collection = _.string.underscored @model.constructor.className\n    patch = new Patch({\n      delta\n      target: { collection, 'id': @model.id }\n      commitMessage: \"Diplomat submission for lang #{@selectedLanguage}: #{flattened.length} change(s).\"\n    })\n    errors = patch.validate()\n    button = $(e.target)\n    button.attr('disabled', 'disabled')\n    return button.text('No changes submitted, did not save patch.') unless delta\n    return button.text('Failed to Submit Changes') if errors\n    res = patch.save(null, { url: _.result(@model, 'url') + '/patch' })\n    return button.text('Failed to Submit Changes') unless res\n    button.text('Submitting...')\n    Promise.resolve(res)\n    .then =>\n      @madeChanges = false\n      @patches.add(patch)\n      @renderSelectors('#patches-col')\n      button.text('Submit Changes')\n    .catch =>\n      button.text('Error Submitting Changes')\n      @$el.find('#patch-submit').attr('disabled', null)\n        \n"]}