{"version":3,"sources":["app/views/editor/level/systems/LevelSystemEditView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/level/systems/LevelSystemEditView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\ntemplate = require 'templates/editor/level/system/level-system-edit-view'\nLevelSystem = require 'models/LevelSystem'\nSystemVersionsModal = require 'views/editor/level/systems/SystemVersionsModal'\nPatchesView = require 'views/editor/PatchesView'\nSaveVersionModal = require 'views/editor/modal/SaveVersionModal'\nace = require 'ace'\n\nrequire 'vendor/treema'\n\nmodule.exports = class LevelSystemEditView extends CocoView\n  id: 'level-system-edit-view'\n  template: template\n  editableSettings: ['name', 'description', 'codeLanguage', 'dependencies', 'propertyDocumentation', 'i18n']\n\n  events:\n    'click #done-editing-system-button': 'endEditing'\n    'click .nav a': (e) -> $(e.target).tab('show')\n    'click #system-patches-tab': -> @patchesView.load()\n    'click #system-code-tab': 'buildCodeEditor'\n    'click #system-config-schema-tab': 'buildConfigSchemaTreema'\n    'click #system-settings-tab': 'buildSettingsTreema'\n    'click #system-history-button': 'showVersionHistory'\n    'click #patch-system-button': 'startPatchingSystem'\n    'click #system-watch-button': 'toggleWatchSystem'\n\n  constructor: (options) ->\n    super options\n    @levelSystem = @supermodel.getModelByOriginalAndMajorVersion LevelSystem, options.original, options.majorVersion or 0\n    console.log 'Couldn\\'t get levelSystem for', options, 'from', @supermodel.models unless @levelSystem\n\n  afterRender: ->\n    super()\n    @buildSettingsTreema()\n    @buildConfigSchemaTreema()\n    @buildCodeEditor()\n    @patchesView = @insertSubView(new PatchesView(@levelSystem), @$el.find('.patches-view'))\n    @updatePatchButton()\n\n  buildSettingsTreema: ->\n    data = _.pick @levelSystem.attributes, (value, key) => key in @editableSettings\n    schema = _.cloneDeep LevelSystem.schema\n    schema.properties = _.pick schema.properties, (value, key) => key in @editableSettings\n    schema.required = _.intersection schema.required, @editableSettings\n    schema.default = _.pick schema.default, (value, key) => key in @editableSettings\n\n    treemaOptions =\n      supermodel: @supermodel\n      schema: schema\n      data: data\n      callbacks: {change: @onSystemSettingsEdited}\n    treemaOptions.readOnly = me.get('anonymous')\n    @systemSettingsTreema = @$el.find('#edit-system-treema').treema treemaOptions\n    @systemSettingsTreema.build()\n    @systemSettingsTreema.open()\n\n  onSystemSettingsEdited: =>\n    # Make sure it validates first?\n    for key, value of @systemSettingsTreema.data\n      @levelSystem.set key, value unless key is 'js' # will compile code if needed\n    @updatePatchButton()\n\n  buildConfigSchemaTreema: ->\n    treemaOptions =\n      supermodel: @supermodel\n      schema: LevelSystem.schema.properties.configSchema\n      data: $.extend true, {}, @levelSystem.get 'configSchema'\n      callbacks: {change: @onConfigSchemaEdited}\n    treemaOptions.readOnly = me.get('anonymous')\n    @configSchemaTreema = @$el.find('#config-schema-treema').treema treemaOptions\n    @configSchemaTreema.build()\n    @configSchemaTreema.open()\n    # TODO: schema is not loaded for the first one here?\n    @configSchemaTreema.tv4.addSchema('metaschema', LevelSystem.schema.properties.configSchema)\n\n  onConfigSchemaEdited: =>\n    @levelSystem.set 'configSchema', @configSchemaTreema.data\n    @updatePatchButton()\n\n  buildCodeEditor: ->\n    @destroyAceEditor(@editor)\n    editorEl = $('<div></div>').text(@levelSystem.get('code')).addClass('inner-editor')\n    @$el.find('#system-code-editor').empty().append(editorEl)\n    @editor = ace.edit(editorEl[0])\n    @editor.setReadOnly(me.get('anonymous'))\n    session = @editor.getSession()\n    session.setMode 'ace/mode/coffee'\n    session.setTabSize 2\n    session.setNewLineMode = 'unix'\n    session.setUseSoftTabs true\n    @editor.on('change', @onEditorChange)\n\n  onEditorChange: =>\n    @levelSystem.set 'code', @editor.getValue()\n    @updatePatchButton()\n\n  updatePatchButton: ->\n    @$el.find('#patch-system-button').toggle Boolean @levelSystem.hasLocalChanges()\n\n  endEditing: (e) ->\n    Backbone.Mediator.publish 'editor:level-system-editing-ended', system: @levelSystem\n    null\n\n  showVersionHistory: (e) ->\n    systemVersionsModal = new SystemVersionsModal {}, @levelSystem.id\n    @openModalView systemVersionsModal\n    Backbone.Mediator.publish 'editor:view-switched', {}\n\n  startPatchingSystem: (e) ->\n    @openModalView new SaveVersionModal({model: @levelSystem})\n    Backbone.Mediator.publish 'editor:view-switched', {}\n\n  toggleWatchSystem: ->\n    console.log 'toggle watch system?'\n    button = @$el.find('#system-watch-button')\n    @levelSystem.watch(button.find('.watch').is(':visible'))\n    button.find('> span').toggleClass('secret')\n\n  destroy: ->\n    @destroyAceEditor(@editor)\n    @systemSettingsTreema?.destroy()\n    @configSchemaTreema?.destroy()\n    super()\n"]}